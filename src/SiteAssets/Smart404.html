<script src="//ajax.aspnetcdn.com/ajax/jQuery/jquery-3.4.1.min.js"></script>
<script>
    var colMatchingVanityURLIItems;
    var ctx;
    var requestUrl;

    // Change these settings to match your own needs
    const timeSeconds = 15;
    const locTitleNotFound = "Not Found";
    const locTitleRedirected = "Page Has Moved";
    const vanityURLsListName = "VanityURLs";
    const spoTenantUrl = null; //"https://yourtenant.sharepoint.com";

    $(() => {
        SP.SOD.executeFunc('sp.js', 'SP.ClientContext', () => {
            // Get the context
            ctx = new SP.ClientContext.get_current();

            // Get the requested URL
            requestUrl = getQueryString().requestUrl;

            // If there was no requested URL, the page is being edited,
            // otherwise, process the requested URL
            if (requestUrl) {
                getRedirectUrl(requestUrl);
            }
        });
    });

    /**
     * Finds a vanity redirect based on a provided URL
     * @param url the requested URL
     */
    function getRedirectUrl(url) {
        console.log("Searching for redirect", url);
        url = url.toLowerCase();

        var vanityUrlsList = ctx.get_web().get_lists().getByTitle(vanityURLsListName);
        ctx.load(vanityUrlsList);

        var camlQuery = new SP.CamlQuery();
        ViewXml = "<View><Query><Where><And><Eq><FieldRef Name='RequestURL' /><Value Type='Text'>" + url + "</Value></Eq><Eq><FieldRef Name='RedirectType' /><Value Type='Choice'>Exact Match</Value></Eq></And></Where><FieldRef Name='Order0' Ascending='True' /></OrderBy></Query></View>"
        camlQuery.set_viewXml(ViewXml);
        colMatchingVanityURLIItems = vanityUrlsList.getItems(camlQuery);
        ctx.load(colMatchingVanityURLIItems);

   
        ctx.executeQueryAsync((_sender, args) => {
            var itemCount = colMatchingVanityURLIItems.get_count();
            if (itemCount > 0) {
                var listItemEnumerator = colMatchingVanityURLIItems.getEnumerator();
                while (listItemEnumerator.moveNext()) {
                    var oListItem = listItemEnumerator.get_current();

                    var redirectType = oListItem.get_item('RedirectType');
                    
                    // Redirect URL
                    var redirectUrl = oListItem.get_item('RedirectURL');

                    var itemRequestUrl = oListItem.get_item('RequestURL');
                    if ((redirectType == "Exact Match") && (itemRequestUrl.toString().toLowerCase() == requestUrl.toString().toLowerCase())) {
                        logExactmatch(redirectUrl, "Exact Match Redirected");
                        redirectToVanityUrl(redirectUrl);
                        return;
                    }
                    else if ((redirectType == "Begins With") && (requestUrl.toString().toLowerCase().search(itemRequestUrl.toString().toLowerCase()) == 0)) {
                        // TODO: Fix this functionality
                        logStartsWith(redirectUrl, "Start With Redirected");
                        redirectUrl = requestUrl.replace(itemRequestUrl, redirectUrl);
                        redirectToVanityUrl(redirectUrl);
                        return;
                    }
                }
               
            }

            console.log("No matching items found", requestUrl);
            
            // See if we can extract the document name AND we have a tenant URL
            if (requestUrl.lastIndexOf('/') > 0 && spoTenantUrl !== null) {
                redirectToSearch(requestUrl);
            } else {
                displayNotFound();
            }

        }, (_sender, args) => {
            console.log('Error: ', args.get_message())
        });
    }

    /**
     * Sets the page title
     * @param pageTitle the title
     */
    function setPageTitle(newTitle) {
        $("#DeltaPlaceHolderPageTitleInTitleArea").text(newTitle);
    }

    /**
     * Indicates that the page is not found
     */
    function displayNotFound() {
        logNoMatch(requestUrl, "Displayed Not Found page");

        // Set the page title
        setPageTitle(locTitleNotFound);

        // Show the Not Found template
        $("#NotFoundTemplate").show();
    }


    /**
     * Logs an entry when a partial match was found
     * @param redirectUrl The redirected url
     * @param outcome The outcome
     */
    function logStartsWith(redirectUrl, outcome) {
        console.log("Logging Starts With Redirect", requestUrl, redirectUrl, outcome);
        createLogEntry(requestUrl, requestUrl, document.referrer, redirectUrl);
    }

    /**
     * Logs an exact match redirect
     * @param redirectUrl The request URL
     * @param outcome The outcome
     */
    function logExactmatch(redirectUrl, outcome) {
        console.log("Logging Exact Match Redirect", requestUrl, redirectUrl, outcome);
        createLogEntry(requestUrl, requestUrl, document.referrer, redirectUrl);
    }

    /**
     * Logs when no match was found
     * @param redirectUrl The requested URL
     * @param outcome The outcome
     */
    function logNoMatch(redirectUrl, outcome) {
        console.log("Logging None Existing", requestUrl, redirectUrl, outcome);
        createLogEntry(outcome, requestUrl, document.referrer, "");
    }

    function createLogEntry(title, requestUrl, referrer, redirectUrl) {
        // Get the log list
        debugger;
        var redirectLog = ctx.get_web().get_lists().getByTitle('RedirectLog');
        console.log("redirectLog", redirectLog);
        var itemCreateInfo = new SP.ListItemCreationInformation();
        var listItem = redirectLog.addItem(itemCreateInfo);
        listItem.set_item('Title', title);
        listItem.set_item('RequestedUrl', requestUrl);
        listItem.set_item('Referrer', referrer);
        listItem.set_item('RedirectedTo', redirectUrl);
        listItem.update();
        ctx.load(listItem);
        ctx.executeQueryAsync(
            () => {
                debugger;
                console.log('Item created: ', listItem.get_id())

            },
            (_sender, args) => {
                debugger;
                console.log('Error: ', args.get_message())
            });
    }
    
    /**
     * Redirects users from the page after a delay
     */
    function redirectToVanityUrl(redirectUrl) {
        // Set the page title
        setPageTitle(locTitleRedirected);

        // Replace redirected URL values
        $("#NewUrl").text(redirectUrl).attr("href", redirectUrl);

        // Display the redirect template
        $("#RedirectingTemplate").show();
        
        console.log("Redirecting to", redirectUrl);

        // Set the redirect timer
        window.setTimeout(() => {
            console.log("Timeout Redirecting to", redirectUrl);
            window.parent.location.href = redirectUrl
        }, timeSeconds * 1000);

        // Start a countdown
        var timeLeft = timeSeconds;

        var downloadTimer = setInterval(()=> {
            $("#countdown").text(timeLeft);
            timeLeft -= 1;
            if (timeLeft <= 0) {
                clearInterval(downloadTimer);
            }
        }, 1000); 
    }

    /**
     * Redirects users from the page after a delay
     */
     function redirectToSearch(requestUrl) {

        const searchQuery = requestUrl.substring(requestUrl.lastIndexOf('/')+1);
        const searchUrl = spoTenantUrl + "/_layouts/15/sharepoint.aspx?q="+ searchQuery +"&v=search";

        createLogEntry("Redirected to search page", requestUrl, document.referrer, searchUrl);
        

        // Set the page title
        setPageTitle(locTitleNotFound);

        $("#SearchUrl").attr("href", searchUrl);

        // Display the redirect template
        $("#RedirectingToSearchTemplate").show();
        
        // Set the redirect timer
        window.setTimeout(() => {
            console.log("Timeout Redirecting to", searchUrl);
            window.parent.location.href = searchUrl
        }, timeSeconds * 1000);

        // Start a countdown
        var timeLeft = timeSeconds;

        var downloadTimer = setInterval(()=> {
            $("#searchCountdown").text(timeLeft);
            timeLeft -= 1;
            if (timeLeft <= 0) {
                clearInterval(downloadTimer);
            }
        }, 1000); 
    }

    function getQueryString() {
        var queryStringKeyValue = window.parent.location.search.replace('?', '').split('&');
        var qsJsonObject = {};
        if (queryStringKeyValue != '') {
            for (i = 0; i < queryStringKeyValue.length; i++) {
                qsJsonObject[queryStringKeyValue[i].split('=')[0]] = queryStringKeyValue[i].split('=')[1];
            }
        }
        return qsJsonObject;
    }
</script>
<style>
    #smart404templates .smart404template {
        display: none;
    }

    #smart404templates .smart404template div {
        padding-top: 16px;
    }
</style>
<div id="smart404templates">
    <div id="NotFoundTemplate" class="smart404template">
        <h1>The page you're looking for does not exist.</h1>
    </div>
    <div id="RedirectingToSearchTemplate" class="smart404template">
        <h1>The page you're looking for does not exist.</h1>
        <div>We will redirect you to your <a id="SearchUrl" href="">Office 365 search page</a> in <span id="searchCountdown">15</span> seconds.</div>
    </div>
    <div id="RedirectingTemplate" class="smart404template">
        <h1>The page you're looking for has moved.</h1>
        <div>Your page has moved to <a id="NewUrl" href=""></a>.</div>
        <div>To avoid getting this message in the future, please update your bookmarks accordingly.</div>
        <div>We will redirect you to your new location in <span id="countdown">15</span> seconds.</div>
    </div>
</div>